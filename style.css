let loginMethod = '';
let userName = '';

// 로그인 ↔ 회원가입 화면 전환
function showSignup() {
  document.getElementById('login-container').style.display = 'none';
  document.getElementById('signup-container').style.display = 'block';
}
function showLogin() {
  document.getElementById('signup-container').style.display = 'none';
  document.getElementById('login-container').style.display = 'block';
}

// 회원가입 처리
function register() {
  const id = document.getElementById('signup-id').value;
  const pw = document.getElementById('signup-pw').value;
  const nickname = document.getElementById('signup-nickname').value;
  const birth = document.getElementById('signup-birth').value;
  if (!id || !pw || !nickname || !birth) {
    alert('모든 정보를 입력하세요!');
    return;
  }
  if (localStorage.getItem('user_' + id)) {
    alert('이미 존재하는 아이디입니다!');
    return;
  }
  localStorage.setItem('user_' + id,
    JSON.stringify({ pw, nickname, birth }));
  alert('회원가입이 완료되었습니다!');
  showLogin();
}

// 로컬 로그인 처리
function login() {
  const id = document.getElementById('login-id').value;
  const pw = document.getElementById('login-pw').value;
  const saved = localStorage.getItem('user_' + id);
  const savedData = saved ? JSON.parse(saved) : null;
  if (savedData && savedData.pw === pw) {
    loginMethod = 'local';
    userName = savedData.nickname;
    proceedToVideo();
  } else {
    document.getElementById('login-result').textContent =
      '❌ 아이디 또는 비밀번호가 일치하지 않습니다.';
  }
}

// Google JWT 디코딩
function decodeJwtResponse(token) {
  const base64Url = token.split('.')[1];
  let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  while (base64.length % 4) base64 += '=';
  const json = decodeURIComponent(
    atob(base64)
      .split('')
      .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
      .join('')
  );
  return JSON.parse(json);
}

// 구글 로그인 콜백
function handleGoogleLogin(response) {
  const payload = decodeJwtResponse(response.credential);
  loginMethod = 'google';
  userName = payload.name || payload.given_name || payload.email.split('@')[0];
  proceedToVideo();
}

// 로그인 완료 → 비디오 재생 → Alice 화면 전환
function proceedToVideo() {
  const loginBox = document.getElementById('login-container');
  loginBox.classList.add('fade');
  loginBox.style.opacity = '0';
  setTimeout(() => {
    loginBox.style.display = 'none';
    const vc = document.getElementById('video-container');
    const video = document.getElementById('intro-video');
    vc.style.display = 'flex';
    video.play().catch(console.error);
    video.addEventListener('ended', () => {
      vc.classList.add('fade-out');
      setTimeout(() => {
        vc.style.display = 'none';
        document.getElementById('alice-container').style.display = 'block';
      }, 2000);
    });
  }, 2000);
}

// 페이지 로드 후 초기화
window.addEventListener('DOMContentLoaded', () => {
  // 목표시간 선택박스 초기화
  const hourSel = document.getElementById('goal-hour');
  const minSel = document.getElementById('goal-minute');
  if (hourSel && minSel) {
    for (let h = 0; h < 24; h++) {
      const o = document.createElement('option');
      o.value = o.textContent = String(h).padStart(2, '0');
      hourSel.append(o);
    }
    for (let m = 0; m < 60; m++) {
      const o = document.createElement('option');
      o.value = o.textContent = String(m).padStart(2, '0');
      minSel.append(o);
    }
  }

  // 설명 토글 처리
  const toggleBtn = document.getElementById('toggle-desc');
  const descPanel = document.getElementById('description-panel');
  if (toggleBtn && descPanel) {
    toggleBtn.addEventListener('click', () => {
      descPanel.classList.toggle('open');
      toggleBtn.textContent = descPanel.classList.contains('open')
        ? '설명 닫기'
        : '설명 보기';
    });
  }
});

// 목표시간 설정
function setGoalTime() {
  const h = document.getElementById('goal-hour').value;
  const m = document.getElementById('goal-minute').value;
  if (h === '' || m === '') {
    alert('목표 시간을 선택해주세요.');
    return;
  }
  const timeInput = `${h}:${m}`;
  document.getElementById('status').textContent =
    loginMethod === 'google'
      ? `${userName} 님의 목표 시간은 ${timeInput}으로 설정되었습니다.`
      : `${userName}님의 목표 시간은 ${timeInput}으로 설정되었습니다.`;
}
